# 一、项目介绍

# 项目背景

通过前端技术埋点，获取指定的业务指标、技术指标、行为指标等数据。对这些数据进行清洗、过滤、汇总、分析后获得目标数据，为未来EBS的智能化、推荐化、行为预测等需求提供一定的技术储备支持。

# 项目目标

1. 优化业务流程：通过对公司内部平台的用户行为进行监测和分析，可以了解用户在平台上的行为习惯、痛点等信息，从而优化业务流程，提高工作效率。
2. 提升用户体验：通过对用户行为的分析，可以了解用户在平台上的使用情况，发现用户的痛点和需求，从而进行相应的优化，提升用户体验。
3. 改进产品设计：通过对用户行为数据的分析，可以了解用户的喜好、偏好等信息，从而改进产品设计，提高产品的吸引力和竞争力。
致力于将 EBS 打造为具有更强的主动性、情感沉浸、智能交互型系统。用户在使用 EBS 时，得到的不是一个普遍被动、冷冰冰、干巴巴的单向软件体验，而是一个具有情感、思想、智能协助的双向交互型体验。

# 项目成员

胡奇焕：

吴国展：

罗俊：

# 二、项目方案内容

# 方案概要

* 需求信息: 前端技术埋点设计方案
* 系统功能版本号: V1
* 方案重要等级: A
# 方案要求

## 性能指标

* 埋点数据采集性能：即在页面加载和用户操作过程中，埋点系统所产生的性能损耗。这个指标包括了埋点代码的大小、加载时间和对页面性能的影响。对于移动设备和低带宽网络，埋点系统的性能影响可能更为明显，因此需要对性能进行优化，例如使用异步加载等方式。
* 数据存储性能：指将采集到的数据存储到数据库或者其他数据存储系统中的性能。这个指标包括了数据写入速度、数据读取速度和数据存储空间等。为了确保数据的实时性和准确性，需要对数据存储进行优化。
* 数据查询性能：指在数据存储系统中查询和分析数据的性能。这个指标包括了数据查询速度和数据查询准确性等。为了能够快速有效地对数据进行分析和应用，需要对查询性能进行优化，例如建立索引等方式。
* 数据安全性：指对采集到的数据进行安全保护和权限控制的能力。这个指标包括了数据加密、数据备份、数据恢复和访问权限控制等。为了保护用户隐私和保证数据的安全性，需要对数据进行加密和备份，并设置访问权限控制策略。
# 架构设计

## 架构实现概要描述

前端通过代码埋点，将各类型埋点数据当设置条件满足时上报发送至服务器存储。进行数据分析处理后，流转至数据平台管理。帮助产品、技术、运营维护人员对 EBS 系统的持续优化提供相关支持。

## 架构图示

* 架构组织图
* [https://www.processon.com/view/link/6405aaa7397b3c6a60fdada9?embed=true](https://www.processon.com/view/link/6405aaa7397b3c6a60fdada9?embed=true)模块关系图
* [https://www.processon.com/view/link/6406dabf1c8923293d870ca3?embed=true](https://www.processon.com/view/link/6406dabf1c8923293d870ca3?embed=true)业务流程图
* [https://www.processon.com/view/link/64069128397b3c6a60fe92af?embed=true](https://www.processon.com/view/link/64069128397b3c6a60fe92af?embed=true)数据流程图
* [https://www.processon.com/view/link/6406fcb55741de2e05c96633?embed=true](https://www.processon.com/view/link/6406fcb55741de2e05c96633?embed=true)数据结构思维导图
* [https://www.processon.com/view/link/6406e5aa2ee0ec1d99222dc6?embed=true](https://www.processon.com/view/link/6406e5aa2ee0ec1d99222dc6?embed=true)数据分析思维导图
* [https://www.processon.com/view/link/6406fad907660904883be342?embed=true](https://www.processon.com/view/link/6406fad907660904883be342?embed=true)接口设计：[https://shimo.im/docs/473QyGORa7TnXV3w](https://shimo.im/docs/473QyGORa7TnXV3w) 《接口数据格式》
# 代码规范

* 命名规范：变量、函数、类等应使用有意义的名称，使用驼峰式命名法，并遵循统一的命名约定。
* 注释规范：需要对代码进行详细的注释，使其易于理解和维护，注释应该简洁、明确，解释代码的意图和目的。
* 缩进规范：在代码块中使用统一的缩进方式，采用是两个空格。
* 函数规范：一个函数应该尽可能简单，并且只完成一个任务，函数应该有清晰的输入和输出，并遵循统一的命名约定。
* 错误处理规范：在代码中加入适当的异常处理，以防止出现错误或异常情况，在代码中记录错误并提供适当的错误消息，以便在必要时进行调试和修复。
# 功能分解

## 埋点参数配置模块

埋点系统启动初始化时，全局可选参数配置

1. 是否开启埋点采集: true
2. 是否跟踪路由切换 (trackRouterChange): true
3. 是否跟踪用户活跃状态 (trackUserActive): true
4. 是否跟踪浏览器 Tab 切换 (trackTabChange): true
5. 设置用户活跃状态阈值 (userActiveDuration): 10 (以分钟为单位)
6. 数据服务器地址 (serverHost)
7. 平台ID (platformID)
## 异常错误采集模块

监听整个EBS系统的各种错误并及时上报，实时通知相关负责人并安排人员处理解决。

1. 异步错误：window.onerror
2. Promise 错误：unhandledrejection
3. VueJS 错误：errorCaptured、errorHandler
## 用户状态探测模块

## [https://www.processon.com/view/link/64054bdbfa1b983e6ab368e7?embed=true](https://www.processon.com/view/link/64054bdbfa1b983e6ab368e7?embed=true)事件行为管理模块

提供一系列 API 供开发者在项目中埋点使用。

* 事件定义规范
    * 命名规范：
        * 事件名：采取大驼峰命名法
        * 属性名：采取 snake 命名法，即单词全部小写，单词间用 "_" 分割
    * 事件属性定义：
        * 公共参数：硬件设备、网络环境、系统平台、软件版本、用户信息。
        * 动态参数：含有业务意义，每个事件单独定义。
* 公共事件：内部预置事件，如全局路由切换、浏览器 TAB 页进入离开、系统登录退出。
* 自定义事件：由业务需求催生的，带有明显业务逻辑的事件，如报价、入库、出库。
## 数据上报发送模块

发送数据时，会存在页面卸载、销毁时异步请求被忽略的问题，所以我们在需要保证发送数据的完整性和及时性。

1. 独立业务域名：因为浏览器存在同一域名下的请求并发限制，独立的业务域名可解决网络资源竞争的问题。
2. 数据提交预检：可配合节流，避免短时间重复数据上传，做好数据校验，不满足条件的数据则在控制台输出错误，丢弃此次上报。
3. 数据上报类型：
    1. 主动：用户手动触发的操作。
    2. 被动：包括不限于路由变化、定时任务、实时推送。
4. 发送请求 API 选择：
        1. 优先使用：Navigator.sendBeacon
        2. 降级处理：new Image && XMLHttpRequest
# 高可用设计

## 兼容性设计

1. 第三方依赖：确保是开源、健壮、企业级。
2. 平台兼容性：代码采用 ES6+ 语法编写，会被编译打包为 ES5 释出以兼容旧版本平台。
3. 核心上报 API 设计：当 Navigator.sendBeacon 不受平台支持，将降级为使用 new Image (小数据) && XMLHttpRequest (大数据) 方式上报。
## Exception处理

中断或出错的可能节点，以及应对处理的方法：

1. 记录日志：在系统中记录异常日志，包括错误信息、堆栈轨迹等信息，以便后续定位和修复问题。
2. 异常告警：设置系统异常告警，当发生异常时，发送邮件或短信通知相关人员，及时处理问题。
3. 异常恢复：对于一些可以恢复的异常，可以尝试进行自动恢复或提示用户进行操作，以确保系统的正常工作。
4. 容灾备份：在系统发生故障时，及时进行容灾备份，确保数据的安全和可靠性。
5. 异常处理测试：对于一些可能发生的异常情况，需要在测试环境下进行充分的测试和验证，确保系统能够正确地处理异常情况。
## 功能退化设计

极端情况下，如何保证主业务继续可用：

* 异地多活：将埋点系统部署在多个地理位置的数据中心，保证其中任何一个数据中心发生故障时，其它数据中心可以接管工作并保证主业务的可用性。
* 自适应降级：在埋点系统故障时，系统可以根据业务的重要性，自动降级，关闭一些较低优先级的功能，以保证主业务的正常运行。
* 限流：当埋点系统负载过高时，可以通过限制并发请求的数量或流量，保证主业务的稳定性和可用性。
* 演练和备份：在实施埋点系统之前，进行充分的演练和测试，以确保系统能够稳定运行。同时，备份系统的数据和代码，以便在系统故障时能够快速恢复。
* 快速响应和恢复：对于埋点系统故障的情况，需要建立紧急响应机制，并配备专业的技术团队，能够快速发现问题、诊断故障、并进行恢复。
# 安全性设计

* 数据存储：在存储数据时，应当校验请求来源，避免被攻击导致数据异常。
* 访问授权：使用埋点服务，须使用经授权的 Key 方能正常使用。
## 权限设计

* 角色权限设计：可以将不同的角色赋予不同的权限，例如管理员可以进行埋点配置和数据分析，而普通用户只能进行数据查询和下载。
* 项目权限设计：可以将不同的埋点项目赋予不同的权限，例如某个部门的员工只能看到自己部门的埋点数据，而不能看到其他部门的数据。
* 数据访问权限设计：可以将不同的数据赋予不同的访问权限，例如某个敏感数据只能由授权人员才能访问。
* 数据导出权限设计：可以将数据导出功能赋予有限制的权限，例如只有一定权限的管理员才能导出数据。
## 测试范围

因为埋点采用全局性埋点，所以影响范围涉及到整个EBS系统，需要在测试环节对整个系统进行常规测试，另外因系统组件存在新旧版组件，也是需要切换测试的。

* 业务流程
    * 客户管理
    * 供应商管理
    * 业务员操作流程
    * 采购员操作流程
    * 其他常规操作流程
* 弹窗操作
* 表格操作
* 表格筛选操作
* 分屏操作
* 菜单操作
* 页面操作
# 日志设计

哪些行为需要添加日志：

* 错误日志
* 业务日志
# 发布说明

## 第一阶段埋点计划

[https://shimo.im/sheets/m5kv9x4847czpbqX/MODOC/](https://shimo.im/sheets/m5kv9x4847czpbqX/MODOC/)


# 三、项目里程碑

[https://shimo.im/docs/5xkGM81E1JIjo43X/](https://shimo.im/docs/5xkGM81E1JIjo43X/) 《项目里程碑》

